<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
  <style>
    :root{
      --bg1:#f7e6ef;
      --bg2:#dff3f0;
      --card:rgba(255,255,255,0.55);
      --line:rgba(0,0,0,0.12);
      --text:#2a2a2a;
      --muted:rgba(0,0,0,0.55);
      --accent:#ff6aa2;
      --accent2:#5ec8ff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 20%, var(--bg1), transparent 60%),
        radial-gradient(1200px 600px at 85% 80%, var(--bg2), transparent 60%),
        linear-gradient(135deg, #f8f3ff, #f2fff9);
      min-height:100vh;
    }
    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 22px 16px 42px;
    }

    .hero{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 18px 18px 14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.06);
    }
    h1{
      margin:0 0 8px;
      font-size: 30px;
      letter-spacing: .02em;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-weight: 600;
    }

    .panel{
      margin-top: 16px;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.06);
    }
    .grid{
      display:grid;
      gap:10px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      margin-left: 6px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 560px){
      .row{ grid-template-columns: 1.2fr 0.8fr; }
    }
    input{
      width:100%;
      padding: 14px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.7);
      outline:none;
      font-size: 16px;
    }
    input::placeholder{ color: rgba(0,0,0,0.35); font-weight:600; }

    .btn{
      width:100%;
      padding: 14px 16px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.6);
      font-weight: 800;
      font-size: 16px;
      cursor:pointer;
    }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(255,106,162,0.95), rgba(255,197,220,0.95));
      border: 0;
      color: white;
      box-shadow: 0 12px 30px rgba(255,106,162,0.25);
    }
    .btnReset{
      background: rgba(94,200,255,0.18);
      color: #136a8a;
      font-weight: 800;
    }
    .note{
      margin: 10px 4px 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }

    .sectionTitle{
      margin: 18px 2px 10px;
      font-size: 18px;
      font-weight: 900;
    }

    .list{
      display:grid;
      gap: 10px;
    }

    .yearHeader{
      margin: 14px 2px 2px;
      font-weight: 900;
      color: rgba(0,0,0,0.7);
      letter-spacing: .03em;
    }

    .habitItem{
      background: rgba(255,255,255,0.55);
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      backdrop-filter: blur(10px);
    }

    /* â˜… 1è¡Œæ§‹æˆï¼šæ—¥ä»˜ / ç¿’æ…£å / â—¯æ—¥ç›® / â–¡å‰Šé™¤ */
    .habitRow{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 2px 2px; /* å°‘ã—ã ã‘å‘¼å¸ */
    }
    .datePill{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(0,0,0,0.18);
      color: rgba(0,0,0,0.72);
      background: rgba(255,255,255,0.45);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      font-weight: 800;
      min-width: 72px;
      text-align:center;
      font-size: 14px;
    }

    /* â˜… ã“ã“ãŒä»Šå›ã®ãƒ¡ã‚¤ãƒ³ï¼šç¿’æ…£åï¼†â—¯æ—¥ç›®ã‚’ã‚¹ã‚¯ã‚·ãƒ§å¯„ã› */
    .habitName{
      flex:1;
      min-width:0;
      font-weight: 900;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: clamp(18px, 4.8vw, 20px);
      letter-spacing: .01em;
    }
    .dayCount{
      white-space: nowrap;
      font-weight: 900;
      color: rgba(0,0,0,0.75);
      font-size: clamp(18px, 4.8vw, 20px);
    }

    .deleteSquare{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.14);
      background: rgba(255,255,255,0.6);
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
      font-weight: 900;
      color: rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .deleteSquare:active{ transform: scale(0.98); }

    .empty{
      border: 2px dashed rgba(0,0,0,0.12);
      border-radius: 18px;
      padding: 18px 14px;
      color: rgba(0,0,0,0.55);
      font-weight: 800;
      background: rgba(255,255,255,0.35);
    }

    .toast{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.06);
      color: rgba(0,0,0,0.65);
      font-weight: 700;
      font-size: 13px;
      display:none;
    }
    .toast.show{ display:block; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
      <p class="sub">ä»Šæ—¥ã‚‚ã‚³ãƒ„ã‚³ãƒ„ã€æœªæ¥ã®è‡ªåˆ†ã«è²¯é‡‘ âœï¸</p>
    </div>

    <div class="panel">
      <div class="grid">
        <div>
          <label for="habitName">ç¿’æ…£å</label>
          <input id="habitName" type="text" placeholder="ä¾‹ï¼šãƒ¨ã‚¬ / è‹±èª10åˆ† / ã‚¹ãƒˆãƒ¬ãƒƒãƒ" />
        </div>

        <div class="row">
          <div>
            <label for="startDate">é–‹å§‹æ—¥</label>
            <input id="startDate" type="date" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="addBtn" class="btn btnPrimary">è¿½åŠ </button>
          </div>
        </div>

        <button id="resetBtn" class="btn btnReset">å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>

        <div class="note">â€»ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰</div>
        <div id="toast" class="toast"></div>
      </div>
    </div>

    <div class="sectionTitle">ä¸€è¦§</div>
    <div id="list" class="list"></div>
  </div>

  <script>
    // ========= è¨­å®š =========
    const STORAGE_KEY = "habitTracker_v2";

    // ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =========
    const $ = (id) => document.getElementById(id);

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function showToast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=>t.classList.remove("show"), 2200);
    }

    function toISODateString(d){
      // YYYY-MM-DD
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function formatMD(dateLike){
      const d = new Date(dateLike);
      const m = d.getMonth()+1;
      const day = d.getDate();
      return `${m}/${day}`;     // m/dï¼ˆã‚¼ãƒ­åŸ‹ã‚ãªã—ï¼‰
    }

    function getYear(dateLike){
      return new Date(dateLike).getFullYear();
    }

    function daysFromStart(dateLike){
      const start = new Date(dateLike);
      const today = new Date();
      // æ—¥ä»˜ã ã‘ã§è¨ˆç®—ï¼ˆæ™‚åˆ»ã®ã‚ºãƒ¬ã‚’ç„¡è¦–ï¼‰
      const s = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const diff = Math.floor((t - s) / 86400000) + 1; // ä»Šæ—¥ã‚’1æ—¥ç›®ã«å«ã‚ã‚‹
      return diff;
    }

    // ========= ãƒ‡ãƒ¼ã‚¿ =========
    function loadHabits(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) return [];
        return parsed;
      }catch{
        return [];
      }
    }

    function saveHabits(habits){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(habits));
    }

    function makeId(){
      return crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2);
    }

    // ========= æç”»ï¼ˆå¹´è¦‹å‡ºã—è‡ªå‹•æŒ¿å…¥ + 1è¡ŒUI + m/dè¡¨ç¤ºï¼‰ =========
    function render(){
      const listEl = $("list");
      const habits = loadHabits();

      listEl.innerHTML = "";

      if(habits.length === 0){
        listEl.innerHTML = `<div class="empty">ã¾ã ç¿’æ…£ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã²ã¨ã¤ç›®ã‚’è¿½åŠ ã—ã¦ã€ã“ã£ãã‚Šè‚²ã¦ã¾ã—ã‚‡ã†ğŸŒ±</div>`;
        return;
      }

      // ä¸¦ã¹æ›¿ãˆï¼šé–‹å§‹æ—¥â†’ç¿’æ…£å
      const sorted = [...habits].sort((a,b)=>{
        const d = new Date(a.startDate) - new Date(b.startDate);
        if(d !== 0) return d;
        return String(a.name).localeCompare(String(b.name), "ja");
      });

      let currentYear = null;

      for(const h of sorted){
        const y = getYear(h.startDate);
        if(y !== currentYear){
          currentYear = y;
          const yEl = document.createElement("div");
          yEl.className = "yearHeader";
          yEl.textContent = `${currentYear}å¹´`;
          listEl.appendChild(yEl);
        }

        const item = document.createElement("div");
        item.className = "habitItem";

        const d = daysFromStart(h.startDate);
        const dayText = d >= 1 ? `${d}æ—¥ç›®` : `æœªè¨­å®š`;

        item.innerHTML = `
          <div class="habitRow">
            <span class="datePill">${formatMD(h.startDate)}</span>
            <span class="habitName">${escapeHtml(h.name)}</span>
            <span class="dayCount">${dayText}</span>
            <button class="deleteSquare" aria-label="å‰Šé™¤" data-id="${h.id}">Ã—</button>
          </div>
        `;

        listEl.appendChild(item);
      }

      // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
      listEl.querySelectorAll(".deleteSquare").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.id;
          deleteHabit(id);
        });
      });
    }

    function addHabit(){
      const name = $("habitName").value.trim();
      const start = $("startDate").value;

      if(!name){
        showToast("ç¿’æ…£åã‚’å…¥ã‚Œã¦ã­ğŸ™‚");
        return;
      }
      if(!start){
        showToast("é–‹å§‹æ—¥ã‚’é¸ã‚“ã§ã­ğŸ“…");
        return;
      }

      // æœªæ¥æ—¥ã¯NG
      const todayISO = toISODateString(new Date());
      if(start > todayISO){
        showToast("æœªæ¥æ—¥ã¯ä¸å¯ã§ã™ï¼ˆä»Šæ—¥ä»¥å‰ã«ã—ã¦ã­ï¼‰");
        return;
      }

      const habits = loadHabits();
      habits.push({ id: makeId(), name, startDate: start });
      saveHabits(habits);

      $("habitName").value = "";

      showToast("è¿½åŠ ã—ãŸã‚ˆâœï¸");
      render();
    }

    function deleteHabit(id){
      const habits = loadHabits();
      const next = habits.filter(h => h.id !== id);
      saveHabits(next);
      showToast("å‰Šé™¤ã—ãŸã‚ˆğŸ§¹");
      render();
    }

    function resetAll(){
      if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ")){
        return;
      }
      localStorage.removeItem(STORAGE_KEY);
      showToast("ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼");
      render();
    }

    // ========= åˆæœŸåŒ– =========
    function init(){
      $("addBtn").addEventListener("click", addHabit);
      $("resetBtn").addEventListener("click", resetAll);

      // Enterã§ã‚‚è¿½åŠ 
      $("habitName").addEventListener("keydown", (e)=>{
        if(e.key === "Enter") addHabit();
      });

      render();
    }

    init();
  </script>
</body>
</html>
